<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= medicine ? medicine.name : 'Product Not Found' %> - Apollo Pharmacy</title>
  <style>
    /* ... (KEEPING YOUR CSS EXACTLY AS IS) ... */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #333; }
    .header { background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%); color: white; padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.15); }
    .header-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
    .logo { font-size: 26px; font-weight: bold; text-decoration: none; color: white; display: flex; align-items: center; gap: 8px; }
    .logo-icon { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #1a237e; font-size: 20px; }
    .search-bar { flex: 1; max-width: 500px; margin: 0 30px; }
    .search-bar input { width: 100%; padding: 12px 20px; border: none; border-radius: 25px; font-size: 14px; outline: none; }
    .header-actions { display: flex; align-items: center; gap: 20px; }
    .header-actions a { color: white; text-decoration: none; font-size: 14px; display: flex; align-items: center; gap: 5px; }
    .cart-badge { background: #ffd600; color: #1a237e; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }
    .main-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .breadcrumb { padding: 15px 0; font-size: 14px; color: #666; }
    .breadcrumb a { color: #3949ab; text-decoration: none; }
    .product-container { display: grid; grid-template-columns: 1fr 1.5fr; gap: 40px; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .product-image { background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%); border-radius: 16px; padding: 40px; display: flex; align-items: center; justify-content: center; min-height: 400px; }
    .product-image-placeholder { width: 180px; height: 180px; background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; color: white; font-size: 60px; }
    .product-details h1 { font-size: 26px; color: #1a237e; margin-bottom: 8px; }
    .brand-name { color: #3949ab; font-size: 15px; font-weight: 500; margin-bottom: 12px; }
    .rating { display: flex; align-items: center; gap: 10px; margin-bottom: 18px; }
    .rating-badge { background: #43a047; color: white; padding: 4px 10px; border-radius: 4px; font-size: 13px; font-weight: bold; }
    .rating-count { color: #666; font-size: 13px; }
    .price-section { background: linear-gradient(135deg, #e8eaf6 0%, #f5f5f5 100%); padding: 20px; border-radius: 12px; margin: 18px 0; }
    .price { font-size: 30px; font-weight: bold; color: #1a237e; }
    .mrp { color: #999; text-decoration: line-through; font-size: 17px; margin-left: 10px; }
    .discount { color: #43a047; font-size: 15px; font-weight: 600; margin-left: 10px; }
    .pack-info { color: #666; font-size: 13px; margin-top: 8px; }
    .prescription-badge { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; margin: 12px 0; }
    .prescription-required { background: #fff8e1; color: #f57c00; border: 1px solid #ffe082; }
    .no-prescription { background: #e8f5e9; color: #388e3c; border: 1px solid #a5d6a7; }
    .delivery-badge { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: #e3f2fd; color: #1565c0; border-radius: 20px; font-size: 12px; font-weight: 600; margin-left: 10px; }
    .stock-status { display: flex; align-items: center; gap: 8px; margin: 12px 0; font-size: 14px; }
    .stock-dot { width: 10px; height: 10px; border-radius: 50%; }
    .stock-dot.in-stock { background: #43a047; }
    .stock-dot.out-of-stock { background: #e53935; }
    .quantity-selector { display: flex; align-items: center; gap: 15px; margin: 18px 0; }
    .quantity-selector label { font-weight: 500; color: #333; }
    .qty-controls { display: flex; align-items: center; border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden; }
    .qty-btn { width: 40px; height: 40px; border: none; background: #f5f5f5; font-size: 18px; cursor: pointer; transition: background 0.3s; }
    .qty-btn:hover { background: #e0e0e0; }
    .qty-input { width: 50px; height: 40px; border: none; text-align: center; font-size: 16px; font-weight: 500; }
    .action-buttons { display: flex; gap: 15px; margin: 22px 0; }
    .btn { padding: 14px 35px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .btn-primary { background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(26, 35, 126, 0.4); }
    .btn-secondary { background: white; color: #1a237e; border: 2px solid #1a237e; }
    .btn-secondary:hover { background: #e8eaf6; }
    .delivery-info { background: #f5f5f5; padding: 15px 20px; border-radius: 10px; margin: 18px 0; }
    .delivery-info h4 { color: #1a237e; margin-bottom: 8px; font-size: 14px; }
    .delivery-info p { color: #666; font-size: 13px; margin: 4px 0; }
    .tabs-section { margin-top: 35px; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .tabs-header { display: flex; background: #f5f5f5; border-bottom: 1px solid #e0e0e0; }
    .tab-btn { padding: 15px 28px; border: none; background: none; font-size: 14px; font-weight: 500; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
    .tab-btn.active { color: #1a237e; border-bottom-color: #1a237e; background: white; }
    .tab-content { padding: 28px; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 18px; }
    .info-item { padding: 14px; background: #f8f9fa; border-radius: 10px; }
    .info-item label { display: block; color: #999; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .info-item p { color: #333; font-size: 14px; font-weight: 500; }
    .dosage-box { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 22px; border-radius: 12px; margin: 18px 0; }
    .dosage-box h4 { color: #1565c0; margin-bottom: 12px; font-size: 16px; }
    .dosage-box p { color: #333; line-height: 1.7; }
    .side-effects-list { list-style: none; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .side-effects-list li { padding: 10px 14px; background: #fff3e0; border-radius: 8px; color: #e65100; font-size: 13px; }
    .side-effects-list li::before { content: "‚ö†Ô∏è "; }
    .related-section { margin-top: 35px; }
    .related-section h2 { font-size: 22px; color: #1a237e; margin-bottom: 18px; }
    .related-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 18px; }
    .product-card { background: white; border-radius: 14px; padding: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: transform 0.3s; }
    .product-card:hover { transform: translateY(-4px); }
    .product-card-image { width: 70px; height: 70px; background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%); border-radius: 12px; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; }
    .product-card h4 { font-size: 13px; color: #333; margin-bottom: 4px; height: 36px; overflow: hidden; }
    .product-card .brand { color: #999; font-size: 11px; margin-bottom: 8px; }
    .product-card .price { font-size: 16px; color: #1a237e; font-weight: bold; }
    .product-card .mrp { font-size: 12px; }
    .product-card a { display: block; text-align: center; margin-top: 10px; color: #3949ab; text-decoration: none; font-weight: 500; font-size: 13px; }
    .footer { background: #1a237e; color: white; padding: 35px 20px; margin-top: 45px; }
    .footer-container { max-width: 1200px; margin: 0 auto; text-align: center; }
    .footer p { color: rgba(255,255,255,0.7); font-size: 13px; }
    .toast { position: fixed; bottom: 30px; right: 30px; background: #1a237e; color: white; padding: 15px 25px; border-radius: 10px; display: none; z-index: 2000; animation: slideIn 0.3s ease; }
    .toast.success { background: #43a047; }
    @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @media (max-width: 768px) { .product-container { grid-template-columns: 1fr; } .related-grid { grid-template-columns: repeat(2, 1fr); } .info-grid, .side-effects-list { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-container">
      <a href="/" class="logo">
        <span class="logo-icon">üè•</span>
        Apollo Pharmacy
      </a>
      <div class="search-bar">
        <input type="text" placeholder="Search medicines, health products...">
      </div>
      <div class="header-actions">
        <a href="/cart">üõí Cart <span class="cart-badge" id="cartCount">0</span></a>
        <a href="#">üë§ Account</a>
      </div>
    </div>
  </header>

  <main class="main-container">
    <% if (medicine) { %>  <div class="breadcrumb">
      <a href="/">Home</a> / <a href="/?category=<%= medicine.category %>"><%= medicine.category %></a> / <%= medicine.name %>
    </div>

    <div class="product-container">
      <div class="product-image">
        <div class="product-image-placeholder">üíä</div>
      </div>
      
      <div class="product-details">
        
        <h1 id="med-name"><%= medicine.name %></h1>
        <p class="brand-name"><%= medicine.brand %> | <%= medicine.manufacturer %></p>
        
        <div class="rating">
          <span class="rating-badge">‚≠ê <%= medicine.rating %></span>
          <span class="rating-count"><%= medicine.reviews.toLocaleString() %> ratings</span>
        </div>
        
        <div class="price-section">
          <span class="price">‚Çπ<span id="med-price"><%= medicine.price.toFixed(2) %></span></span>
          <span class="mrp">‚Çπ<%= medicine.mrp.toFixed(2) %></span>
          <span class="discount"><%= medicine.discount %>% OFF</span>
          <p class="pack-info">Pack of <%= medicine.quantity %> <%= medicine.unit %></p>
        </div>
        
        <div>
          <% if (medicine.prescriptionRequired) { %>
            <span class="prescription-badge prescription-required">üìã Rx Required</span>
          <% } else { %>
            <span class="prescription-badge no-prescription">‚úì OTC Product</span>
          <% } %>
          <span class="delivery-badge">üöÄ <%= medicine.deliveryTime %> Delivery</span>
        </div>
        
        <div class="stock-status">
          <span class="stock-dot <%= medicine.inStock ? 'in-stock' : 'out-of-stock' %>"></span>
          <span><%= medicine.inStock ? 'In Stock' : 'Out of Stock' %> (<%= medicine.stockCount %> units)</span>
        </div>
        
        <div class="quantity-selector">
          <label>Qty:</label>
          <div class="qty-controls">
            <button class="qty-btn" onclick="updateQty(-1)">‚àí</button>
            <input type="number" class="qty-input" id="quantity" value="1" min="1" max="10">
            <button class="qty-btn" onclick="updateQty(1)">+</button>
          </div>
        </div>
        
        <div class="action-buttons">
            <button id="add-to-cart" class="btn btn-primary" onclick="addToCart('<%= medicine.id %>')" <%= !medicine.inStock ? 'disabled' : '' %>>
            üõí Add to Cart
          </button>
          <button class="btn btn-secondary" onclick="buyNow('<%= medicine.id %>')">
            ‚ö° Buy Now
          </button>
        </div>
        
        <div class="delivery-info">
          <h4>üöö Delivery Options</h4>
          <p>‚úì Express delivery in <%= medicine.deliveryTime %></p>
          <p>‚úì Free delivery on orders above ‚Çπ400</p>
          <p>‚úì Cash on delivery available</p>
        </div>
      </div>
    </div>

    <div class="tabs-section">
      <div class="tabs-header">
        <button class="tab-btn active" onclick="showTab('description')">Product Info</button>
        <button class="tab-btn" onclick="showTab('dosage')">How to Use</button>
        <button class="tab-btn" onclick="showTab('sideeffects')">Side Effects</button>
        <button class="tab-btn" onclick="showTab('storage')">Storage</button>
      </div>
      
      <div class="tab-content">
        <div id="description" class="tab-panel active">
          <h3>About <%= medicine.name %></h3>
          <p style="margin: 14px 0; line-height: 1.7;"><%= medicine.description %></p>
          
          <div class="info-grid">
            <div class="info-item"><label>Generic Name</label><p><%= medicine.genericName %></p></div>
            <div class="info-item"><label>Composition</label><p><%= medicine.composition %></p></div>
            <div class="info-item"><label>Category</label><p><%= medicine.category %></p></div>
            <div class="info-item"><label>Manufacturer</label><p><%= medicine.manufacturer %></p></div>
            <div class="info-item"><label>Expiry Date</label><p><%= new Date(medicine.expiryDate).toLocaleDateString('en-IN', { month: 'long', year: 'numeric' }) %></p></div>
            <div class="info-item"><label>Prescription</label><p><%= medicine.prescriptionRequired ? 'Required' : 'Not Required' %></p></div>
          </div>
        </div>
        
        <div id="dosage" class="tab-panel">
          <h3>Dosage & Administration</h3>
          <div class="dosage-box">
            <h4>üìã Recommended Usage</h4>
            <p><%= medicine.dosageInstructions %></p>
          </div>
          <p style="margin-top: 14px; color: #666;">
            <strong>Note:</strong> Always consult your doctor or pharmacist before taking any medication. 
            Do not exceed the recommended dose without medical advice.
          </p>
        </div>
        
        <div id="sideeffects" class="tab-panel">
          <h3>Possible Side Effects</h3>
          <p style="margin: 14px 0; color: #666;">Common side effects that may occur:</p>
          <ul class="side-effects-list">
            <% medicine.sideEffects.forEach(effect => { %>
              <li><%= effect %></li>
            <% }); %>
          </ul>
          <p style="margin-top: 18px; padding: 14px; background: #ffebee; border-radius: 8px; color: #c62828; font-size: 13px;">
            ‚ö†Ô∏è <strong>Seek immediate help</strong> if you experience severe allergic reactions like difficulty breathing or swelling.
          </p>
        </div>
        
        <div id="storage" class="tab-panel">
          <h3>Storage Instructions</h3>
          <div style="padding: 18px; background: #f5f5f5; border-radius: 10px;">
            <p style="font-size: 15px;"><%= medicine.storageInstructions %></p>
          </div>
          <ul style="margin-top: 18px; line-height: 2; color: #666; font-size: 14px;">
            <li>Keep out of reach of children</li>
            <li>Do not use after expiry date</li>
            <li>Store in original packaging</li>
            <li>Protect from direct sunlight</li>
          </ul>
        </div>
      </div>
    </div>

    <% if (relatedProducts && relatedProducts.length > 0) { %>
    <section class="related-section">
      <h2>Similar Products</h2>
      <div class="related-grid">
        <% relatedProducts.forEach(product => { %>
          <div class="product-card">
            <div class="product-card-image">üíä</div>
            <h4><%= product.name %></h4>
            <p class="brand"><%= product.brand %></p>
            <p class="price">‚Çπ<%= product.price.toFixed(2) %> <span class="mrp">‚Çπ<%= product.mrp.toFixed(2) %></span></p>
            <a href="/product/<%= product.id %>">View Details ‚Üí</a>
          </div>
        <% }); %>
      </div>
    </section>
    <% } %>

    <% } else { %>
      <div style="text-align: center; padding: 50px;">
          <h1>üòï Medicine Not Found</h1>
          <p>We couldn't find the medicine you were looking for.</p>
          <a href="/" class="btn btn-primary" style="margin-top: 20px; display: inline-block;">Go Back Home</a>
      </div>
  <% } %>
  </main>

  <footer class="footer">
    <div class="footer-container">
      <p>¬© 2025 Apollo Pharmacy Mock - For Testing Purposes Only</p>
      <p style="margin-top: 8px;">This is a mock website for MCP server testing. Not a real pharmacy.</p>
    </div>
  </footer>

  <div class="toast" id="toast"></div>

  <script>
    // BOT FIX 4: Safety Check for JavaScript
    const medicineId = "<%= medicine ? medicine.id : '' %>";
    const userId = 'user123';
    
    function updateQty(change) {
      const input = document.getElementById('quantity');
      if (!input) return;
      let value = parseInt(input.value) + change;
      if (value < 1) value = 1;
      if (value > 10) value = 10;
      input.value = value;
    }
    
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }
    
    function showTab(tabId) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
      event.target.classList.add('active');
      const tab = document.getElementById(tabId);
      if(tab) tab.classList.add('active');
    }
    
    async function addToCart(medicineId) {
      if(!medicineId) return;
      const quantity = parseInt(document.getElementById('quantity').value);
      try {
        const response = await fetch(`/api/cart/${userId}/add`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ medicineId, quantity })
        });
        const data = await response.json();
        if (data.success) {
          showToast('‚úì Added to cart!', 'success');
          const cartCount = document.getElementById('cartCount');
          if(cartCount) cartCount.textContent = data.data.itemCount;
        } else {
          showToast(data.error || 'Failed to add', 'error');
        }
      } catch (error) {
        showToast('Error adding to cart', 'error');
      }
    }
    
    async function buyNow(medicineId) {
      await addToCart(medicineId);
      window.location.href = '/checkout?userId=' + userId;
    }
    
    async function loadCartCount() {
      try {
        const response = await fetch(`/api/cart/${userId}`);
        const data = await response.json();
        if (data.success) {
          const cartCount = document.getElementById('cartCount');
          if(cartCount) cartCount.textContent = data.data.itemCount || 0;
        }
      } catch (error) {}
    }
    
    loadCartCount();
  </script>
</body>
</html>